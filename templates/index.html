<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Capture System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .status-running {
            background: #4CAF50;
            color: white;
        }
        
        .status-stopped {
            background: #f44336;
            color: white;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .camera-item {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .camera-name {
            font-weight: bold;
            font-size: 16px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .camera-status {
            font-size: 14px;
            color: #666;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: #666;
            font-weight: 500;
        }
        
        .stat-value {
            color: #333;
            font-weight: bold;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-success {
            background: #4CAF50;
        }
        
        .btn-success:hover {
            background: #45a049;
        }
        
        .btn-danger {
            background: #f44336;
        }
        
        .btn-danger:hover {
            background: #da190b;
        }
        
        .gallery {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .gallery-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .gallery-controls select {
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .image-card {
            background: #f5f5f5;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .image-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            cursor: pointer;
        }
        
        .image-info {
            padding: 10px;
        }
        
        .image-filename {
            font-weight: bold;
            font-size: 12px;
            color: #333;
            margin-bottom: 5px;
            word-break: break-all;
        }
        
        .image-meta {
            font-size: 11px;
            color: #666;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .pagination button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .pagination button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .enabled {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .disabled {
            color: #f44336;
            font-weight: bold;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            cursor: pointer;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            background: #f5f5f5;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .tab-btn:hover {
            background: #e0e0e0;
        }
        
        .tab-btn.active {
            background: #667eea;
            color: white;
            border-color: #5568d3;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Date picker */
        input[type="date"] {
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
        }
        
        /* Health status indicators */
        .health-item {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .health-status-online {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .health-status-offline {
            color: #f44336;
            font-weight: bold;
        }
        
        /* Storage chart */
        .storage-chart {
            margin: 20px 0;
        }
        
        .chart-row {
            margin-bottom: 15px;
        }
        
        .chart-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .chart-bar {
            background: #e0e0e0;
            height: 25px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .chart-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .image-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>🎥 Camera Capture System</h1>
                    <p id="system-status">Loading system status...</p>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="reloadConfig()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; text-decoration: none; border-radius: 5px; font-size: 14px; cursor: pointer;">🔄 Reload Config</button>
                    <a href="/change-password" style="padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 5px; font-size: 14px;">🔑 Change Password</a>
                    <a href="/logout" style="padding: 8px 16px; background: #f44336; color: white; text-decoration: none; border-radius: 5px; font-size: 14px;">🚪 Logout</a>
                </div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('dashboard')">📊 Dashboard</button>
            <button class="tab-btn" onclick="showTab('storage')">💾 Storage Analysis</button>
            <button class="tab-btn" onclick="showTab('by-date')">📅 View by Date</button>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="grid">
                <!-- Camera Health Card -->
                <div class="card">
                    <h2>📹 Camera Health</h2>
                    <div id="camera-health">Loading...</div>
                </div>
                
                <!-- System Monitor Card -->
                <div class="card">
                    <h2>🌡️ System Monitor</h2>
                    <div id="system-monitor">Loading...</div>
                </div>
                
                <!-- Capture Statistics Card -->
                <div class="card">
                    <h2>📊 Capture Statistics</h2>
                    <div id="capture-stats">Loading...</div>
                </div>
                
                <!-- Upload Statistics Card -->
                <div class="card">
                    <h2>☁️ Upload Statistics</h2>
                    <div id="upload-stats">Loading...</div>
                </div>
                
                <!-- Storage Statistics Card -->
                <div class="card">
                    <h2>💾 Storage Statistics</h2>
                    <div id="storage-stats">Loading...</div>
                </div>
                
                <!-- GPIO Status Card -->
                <div class="card">
                    <h2>🔌 GPIO Status</h2>
                    <div id="gpio-status">Loading...</div>
                </div>
            
                <!-- Manual Capture Card -->
                <div class="card">
                    <h2>📸 Manual Capture</h2>
                    <div>
                        <button class="btn btn-success" onclick="captureImage('camera_1')">Capture r1 (Entry)</button>
                        <button class="btn btn-success" onclick="captureImage('camera_2')">Capture r2 (Exit)</button>
                        <button class="btn btn-success" onclick="captureImage('camera_3')">Capture r3 (Auxiliary)</button>
                        <button class="btn btn-danger" onclick="runCleanup()">Run Cleanup Now</button>
                    </div>
                </div>
            </div>
            
            <!-- Image Gallery -->
            <div class="gallery">
                <h2>🖼️ Recent Images</h2>
                <div class="gallery-controls">
                    <select id="camera-filter" onchange="filterImages()">
                        <option value="">All Cameras</option>
                        <option value="r1">r1 (Entry)</option>
                        <option value="r2">r2 (Exit)</option>
                        <option value="r3">r3 (Auxiliary)</option>
                    </select>
                    <button class="btn" onclick="refreshImages()">Refresh</button>
                </div>
                <div id="image-gallery" class="image-grid">
                    <div class="loading">Loading images...</div>
                </div>
                <div class="pagination" id="pagination"></div>
            </div>
        </div>
        
        <!-- Storage Analysis Tab -->
        <div id="storage-tab" class="tab-content">
            <div class="gallery">
                <h2>💾 Storage Analysis</h2>
                <div id="storage-analysis">
                    <div class="loading">Loading storage analysis...</div>
                </div>
            </div>
        </div>
        
        <!-- By Date Tab -->
        <div id="by-date-tab" class="tab-content">
            <div class="gallery">
                <h2>📅 View Images by Date</h2>
                <div class="gallery-controls">
                    <input type="date" id="date-picker" onchange="loadImagesByDate()">
                    <select id="date-camera-filter" onchange="loadImagesByDate()">
                        <option value="">All Cameras</option>
                        <option value="r1">r1 (Entry)</option>
                        <option value="r2">r2 (Exit)</option>
                        <option value="r3">r3 (Auxiliary)</option>
                    </select>
                    <button class="btn" onclick="loadImagesByDate()">Load Images</button>
                </div>
                <div id="date-image-gallery" class="image-grid">
                    <div class="loading">Select a date to view images</div>
                </div>
                <div class="pagination" id="date-pagination"></div>
            </div>
        </div>
    </div>
    
    <!-- Image Modal -->
    <div id="image-modal" class="modal" onclick="closeModal()">
        <span class="modal-close">&times;</span>
        <img id="modal-image" src="" alt="Full size image">
    </div>
    
    <script>
        let currentPage = 1;
        let currentFilter = '';
        
        // Current date page
        let currentDatePage = 1;
        
        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            // Load data for tab
            if (tabName === 'storage') {
                loadStorageAnalysis();
            } else if (tabName === 'by-date') {
                // Set date picker to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('date-picker').value = today;
            }
        }
        
        // Update status on page load
        updateStatus();
        updateStats();
        updateHealth();
        loadImages(1);
        
        // Auto-refresh every 10 seconds
        setInterval(updateStatus, 10000);
        setInterval(updateStats, 10000);
        setInterval(updateHealth, 10000);
        
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.success) {
                    // Update system status
                    document.getElementById('system-status').innerHTML = `
                        System Status: <span class="status-badge status-running">${data.status.toUpperCase()}</span>
                        <span style="margin-left: 20px; color: #666;">Last Updated: ${new Date(data.timestamp).toLocaleTimeString()}</span>
                    `;
                    
                    // Update GPIO status
                    const gpioHTML = `
                        <div class="stat-item">
                            <span class="stat-label">Available:</span>
                            <span class="stat-value ${data.gpio.available ? 'enabled' : 'disabled'}">${data.gpio.available ? 'YES' : 'NO'}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Enabled:</span>
                            <span class="stat-value ${data.gpio.enabled ? 'enabled' : 'disabled'}">${data.gpio.enabled ? 'YES' : 'NO'}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Triggering:</span>
                            <span class="stat-value ${data.gpio.trigger_enabled ? 'enabled' : 'disabled'}">${data.gpio.trigger_enabled ? 'YES' : 'NO'}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Upload:</span>
                            <span class="stat-value ${data.upload.enabled ? 'enabled' : 'disabled'}">${data.upload.enabled ? 'ENABLED' : 'DISABLED'}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Retention:</span>
                            <span class="stat-value">${data.retention.retention_days} days</span>
                        </div>
                    `;
                    document.getElementById('gpio-status').innerHTML = gpioHTML;
                }
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }
        
        async function updateStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    
                    // Update capture stats
                    let captureHTML = '';
                    for (const [camera, cameraStats] of Object.entries(stats.capture.cameras || {})) {
                        captureHTML += `
                            <div class="stat-item">
                                <span class="stat-label">${camera}:</span>
                                <span class="stat-value">${cameraStats.successful}/${cameraStats.total_captures}</span>
                            </div>
                        `;
                    }
                    document.getElementById('capture-stats').innerHTML = captureHTML || '<p>No capture data</p>';
                    
                    // Update upload stats
                    const uploadStats = stats.capture.upload_stats || {};
                    const isOffline = uploadStats.offline_mode || false;
                    const offlineIcon = isOffline ? '🔴' : '🟢';
                    const offlineText = isOffline ? 'OFFLINE' : 'ONLINE';
                    const offlineClass = isOffline ? 'disabled' : 'enabled';
                    
                    const uploadHTML = `
                        <div class="stat-item">
                            <span class="stat-label">Status:</span>
                            <span class="stat-value ${offlineClass}">${offlineIcon} ${offlineText}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Queued:</span>
                            <span class="stat-value">${uploadStats.total_queued || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Uploaded:</span>
                            <span class="stat-value">${uploadStats.total_uploaded || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Failed:</span>
                            <span class="stat-value">${uploadStats.total_failed || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Queue Size:</span>
                            <span class="stat-value">${uploadStats.queue_size || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Pending Retry:</span>
                            <span class="stat-value" style="color: ${uploadStats.pending_retry > 0 ? '#ff9800' : '#666'}">${uploadStats.pending_retry || 0}</span>
                        </div>
                    `;
                    document.getElementById('upload-stats').innerHTML = uploadHTML;
                    
                    // Update storage stats
                    const cleanupStats = stats.cleanup || {};
                    const storageHTML = `
                        <div class="stat-item">
                            <span class="stat-label">Total Images:</span>
                            <span class="stat-value">${cleanupStats.current_image_count || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Storage Used:</span>
                            <span class="stat-value">${cleanupStats.total_storage_mb || 0} MB</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total Cleaned:</span>
                            <span class="stat-value">${cleanupStats.total_cleaned || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Last Cleanup:</span>
                            <span class="stat-value">${cleanupStats.last_cleanup ? new Date(cleanupStats.last_cleanup).toLocaleString() : 'Never'}</span>
                        </div>
                    `;
                    document.getElementById('storage-stats').innerHTML = storageHTML;
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }
        
        async function loadImages(page = 1) {
            currentPage = page;
            
            try {
                const response = await fetch(`/api/images?page=${page}&per_page=50&camera=${currentFilter}`);
                const data = await response.json();
                
                if (data.success) {
                    const gallery = document.getElementById('image-gallery');
                    
                    if (data.images.length === 0) {
                        gallery.innerHTML = '<div class="loading">No images found</div>';
                        document.getElementById('pagination').innerHTML = '';
                        return;
                    }
                    
                    // Render images
                    let imagesHTML = '';
                    for (const image of data.images) {
                        imagesHTML += `
                            <div class="image-card">
                                <img src="/api/images/${image.filename}" alt="${image.filename}" onclick="openModal('/api/images/${image.filename}')">
                                <div class="image-info">
                                    <div class="image-filename">${image.filename}</div>
                                    <div class="image-meta">
                                        ${image.size_kb} KB | ${image.age_days} days old
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    gallery.innerHTML = imagesHTML;
                    
                    // Render pagination
                    const pagination = data.pagination;
                    let paginationHTML = `
                        <button onclick="loadImages(1)" ${page === 1 ? 'disabled' : ''}>First</button>
                        <button onclick="loadImages(${page - 1})" ${page === 1 ? 'disabled' : ''}>Previous</button>
                        <span style="padding: 8px 16px; background: white; border-radius: 5px;">Page ${page} of ${pagination.pages}</span>
                        <button onclick="loadImages(${page + 1})" ${page === pagination.pages ? 'disabled' : ''}>Next</button>
                        <button onclick="loadImages(${pagination.pages})" ${page === pagination.pages ? 'disabled' : ''}>Last</button>
                    `;
                    document.getElementById('pagination').innerHTML = paginationHTML;
                }
            } catch (error) {
                console.error('Error loading images:', error);
                document.getElementById('image-gallery').innerHTML = '<div class="loading">Error loading images</div>';
            }
        }
        
        function filterImages() {
            currentFilter = document.getElementById('camera-filter').value;
            loadImages(1);
        }
        
        function refreshImages() {
            loadImages(currentPage);
            updateStats();
        }
        
        async function captureImage(cameraKey) {
            try {
                const response = await fetch(`/api/capture/${cameraKey}`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert(`Image captured successfully: ${data.image.filename}`);
                    refreshImages();
                } else {
                    alert(`Failed to capture image: ${data.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function runCleanup() {
            if (!confirm('Are you sure you want to run cleanup now? This will delete images older than the retention period.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/cleanup/run', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    refreshImages();
                } else {
                    alert(`Failed to run cleanup: ${data.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function updateHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                if (data.success) {
                    const health = data.health;
                    
                    // Update camera health
                    let healthHTML = '';
                    for (const [key, status] of Object.entries(health.camera_health || {})) {
                        const isOnline = status.online;
                        const statusClass = isOnline ? 'health-status-online' : 'health-status-offline';
                        const statusText = isOnline ? '🟢 ONLINE' : '🔴 OFFLINE';
                        
                        healthHTML += `
                            <div class="health-item">
                                <div class="camera-name">${key.toUpperCase()}</div>
                                <div class="${statusClass}">${statusText}</div>
                                ${status.error ? `<div style="color: #f44336; font-size: 12px; margin-top: 5px;">${status.error}</div>` : ''}
                            </div>
                        `;
                    }
                    document.getElementById('camera-health').innerHTML = healthHTML || '<p>No health data</p>';
                    
                    // Update system monitor
                    const system = health.system || {};
                    const temp = system.cpu_temp;
                    const tempHTML = `
                        <div class="stat-item">
                            <span class="stat-label">CPU Temperature:</span>
                            <span class="stat-value" style="color: ${temp && temp > 70 ? '#f44336' : temp && temp > 60 ? '#ff9800' : '#4CAF50'}">
                                ${temp ? temp + system.cpu_temp_unit : 'N/A'}
                            </span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Status:</span>
                            <span class="stat-value ${temp && temp > 70 ? 'disabled' : 'enabled'}">
                                ${temp && temp > 70 ? '⚠️ HIGH' : temp && temp > 60 ? '⚡ WARM' : temp ? '✓ NORMAL' : 'N/A'}
                            </span>
                        </div>
                    `;
                    document.getElementById('system-monitor').innerHTML = tempHTML;
                }
            } catch (error) {
                console.error('Error updating health:', error);
            }
        }
        
        async function loadStorageAnalysis() {
            try {
                const response = await fetch('/api/storage/analysis');
                const data = await response.json();
                
                if (data.success) {
                    const analysis = data.analysis;
                    
                    // Summary
                    let html = `
                        <div class="stat-item">
                            <span class="stat-label">Total Images:</span>
                            <span class="stat-value">${analysis.total_images}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total Size:</span>
                            <span class="stat-value">${analysis.total_size_gb} GB (${analysis.total_size_mb} MB)</span>
                        </div>
                        
                        <h3 style="margin: 20px 0 10px 0;">By Camera</h3>
                        <div class="storage-chart">
                    `;
                    
                    // By camera chart
                    const maxCam = Math.max(...Object.values(analysis.by_camera));
                    for (const [camera, count] of Object.entries(analysis.by_camera)) {
                        const percentage = maxCam > 0 ? (count / maxCam) * 100 : 0;
                        html += `
                            <div class="chart-row">
                                <div class="chart-label">
                                    <span><strong>${camera}</strong></span>
                                    <span>${count} images</span>
                                </div>
                                <div class="chart-bar">
                                    <div class="chart-fill" style="width: ${percentage}%">${count}</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    html += `
                        </div>
                        
                        <h3 style="margin: 20px 0 10px 0;">Last 30 Days</h3>
                        <div class="storage-chart">
                    `;
                    
                    // By date chart (last 30 days)
                    const dates = Object.entries(analysis.by_date).slice(0, 30);
                    const maxDate = Math.max(...dates.map(([_, v]) => v.count));
                    for (const [date, stats] of dates) {
                        const percentage = maxDate > 0 ? (stats.count / maxDate) * 100 : 0;
                        html += `
                            <div class="chart-row">
                                <div class="chart-label">
                                    <span><strong>${date}</strong></span>
                                    <span>${stats.count} images (${stats.size_mb} MB)</span>
                                </div>
                                <div class="chart-bar">
                                    <div class="chart-fill" style="width: ${percentage}%">${stats.count}</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                    
                    document.getElementById('storage-analysis').innerHTML = html;
                } else {
                    document.getElementById('storage-analysis').innerHTML = '<p>Error loading storage analysis</p>';
                }
            } catch (error) {
                console.error('Error loading storage analysis:', error);
                document.getElementById('storage-analysis').innerHTML = '<p>Error loading storage analysis</p>';
            }
        }
        
        async function loadImagesByDate(page = 1) {
            currentDatePage = page;
            
            const date = document.getElementById('date-picker').value;
            const camera = document.getElementById('date-camera-filter').value;
            
            if (!date) {
                document.getElementById('date-image-gallery').innerHTML = '<div class="loading">Please select a date</div>';
                return;
            }
            
            try {
                const response = await fetch(`/api/images/by-date?date=${date}&page=${page}&per_page=50&camera=${camera}`);
                const data = await response.json();
                
                if (data.success) {
                    const gallery = document.getElementById('date-image-gallery');
                    
                    if (data.images.length === 0) {
                        gallery.innerHTML = '<div class="loading">No images found for this date</div>';
                        document.getElementById('date-pagination').innerHTML = '';
                        return;
                    }
                    
                    // Render images
                    let imagesHTML = '';
                    for (const image of data.images) {
                        imagesHTML += `
                            <div class="image-card">
                                <img src="/api/images/${image.filename}" alt="${image.filename}" onclick="openModal('/api/images/${image.filename}')">
                                <div class="image-info">
                                    <div class="image-filename">${image.filename}</div>
                                    <div class="image-meta">
                                        ${image.size_kb} KB | ${image.age_days} days old
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    gallery.innerHTML = imagesHTML;
                    
                    // Render pagination
                    const pagination = data.pagination;
                    let paginationHTML = `
                        <button onclick="loadImagesByDate(1)" ${page === 1 ? 'disabled' : ''}>First</button>
                        <button onclick="loadImagesByDate(${page - 1})" ${page === 1 ? 'disabled' : ''}>Previous</button>
                        <span style="padding: 8px 16px; background: white; border-radius: 5px;">Page ${page} of ${pagination.pages}</span>
                        <button onclick="loadImagesByDate(${page + 1})" ${page === pagination.pages ? 'disabled' : ''}>Next</button>
                        <button onclick="loadImagesByDate(${pagination.pages})" ${page === pagination.pages ? 'disabled' : ''}>Last</button>
                    `;
                    document.getElementById('date-pagination').innerHTML = paginationHTML;
                }
            } catch (error) {
                console.error('Error loading images by date:', error);
                document.getElementById('date-image-gallery').innerHTML = '<div class="loading">Error loading images</div>';
            }
        }
        
        function openModal(imageSrc) {
            document.getElementById('modal-image').src = imageSrc;
            document.getElementById('image-modal').classList.add('active');
        }
        
        async function reloadConfig() {
            if (!confirm('Reload configuration from .env file?\n\nThis will apply any changes to RTSP URLs or enable/disable switches.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/config/reload', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('✓ Configuration reloaded successfully!\n\nRTSP URLs and camera enable/disable settings have been updated.');
                    // Refresh the page to show updated status
                    updateStatus();
                    updateHealth();
                } else {
                    alert(`Failed to reload configuration: ${data.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        function closeModal() {
            document.getElementById('image-modal').classList.remove('active');
        }
    </script>
</body>
</html>


